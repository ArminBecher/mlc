variables:
    RUST_BACKTRACE: "FULL"

stages:
  - test
  - build
  - release

test_latest:
    stage: test
    image: "rust:latest"
    script:
      - rustc --version && cargo --version
      - cargo build
      - cargo test --all --verbose

test_nightly:
    stage: test
    image: rustlang/rust:nightly
    script:
      - rustc --version && cargo --version
      - cargo build
      - cargo test --all --verbose
    allow_failure: true

build_linux_job:
  stage: build
  image: "rust:latest"
  artifacts:
    paths:
      - target/release/linkchecker
  script:
    - cargo build --verbose --release

release_debian_job:
  stage: release
  image: "rust:latest"
  artifacts:
    paths:
      - target/debian
  script:
    - cargo install cargo-deb
    - cargo deb
    - echo "CI_COMMIT_REF_NAME $CI_COMMIT_REF_NAME"
    - echo "CI_COMMIT_TAG $CI_COMMIT_TAG"
    - >-
        curl
        --request POST
        --header 'Content-Type: application/json'
        --header "Private-Token: $CI_API_TOKEN"
        --data '{
        "name": "Release $CI_COMMIT_REF_NAME",
        "tag_name": "$CI_COMMIT_REF_NAME",
        "description": "Release with binary as [debian package](https://gitlab.com/becheran/link-checker/-/jobs/artifacts/$CI_COMMIT_REF_NAME/download?job=release_debian_job)."
        }
        '
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/releases"
  only:
    - tags